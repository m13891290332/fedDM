## 1. FedNum算法架构组件

```
┌──────────────────────────┐  ┌──────────────────────────┐  ┌──────────────────────────┐
│      客户端 1             │  │      客户端 2             │  │      客户端 N             │
│ (FedNumClient)          │  │ (FedNumClient)          │  │ (FedNumClient)          │
│                         │  │                         │  │                         │
│ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │
│ │本地数据              │ │  │ │本地数据              │ │  │ │本地数据              │ │
│ │(Non-IID Dataset)   │ │  │ │(Non-IID Dataset)   │ │  │ │(Non-IID Dataset)   │ │
│ └─────────────────────┘ │  │ └─────────────────────┘ │  │ └─────────────────────┘ │
│           │             │  │           │             │  │           │             │
│           ▼             │  │           ▼             │  │           ▼             │
│ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │
│ │接收全局模型          │ │  │ │接收全局模型          │ │  │ │接收全局模型          │ │
│ │global_model.embed() │ │  │ │global_model.embed() │ │  │ │global_model.embed() │ │
│ │global_model()       │ │  │ │global_model()       │ │  │ │global_model()       │ │
│ └─────────────────────┘ │  │ └─────────────────────┘ │  │ └─────────────────────┘ │
│           │             │  │           │             │  │           │             │
│           ▼             │  │           ▼             │  │           ▼             │
│ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │
│ │特征和Logits提取      │ │  │ │特征和Logits提取      │ │  │ │特征和Logits提取      │ │
│ │- 批量前向传播        │ │  │ │- 批量前向传播        │ │  │ │- 批量前向传播        │ │
│ │- 获取embed特征       │ │  │ │- 获取embed特征       │ │  │ │- 获取embed特征       │ │
│ │- 获取logits输出      │ │  │ │- 获取logits输出      │ │  │ │- 获取logits输出      │ │
│ └─────────────────────┘ │  │ └─────────────────────┘ │  │ └─────────────────────┘ │
│           │             │  │           │             │  │           │             │
│           ▼             │  │           ▼             │  │           ▼             │
│ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │  │ ┌─────────────────────┐ │
│ │按组平均化处理        │ │  │ │按组平均化处理        │ │  │ │按组平均化处理        │ │
│ │- 按avg_num分组       │ │  │ │- 按avg_num分组       │ │  │ │- 按avg_num分组       │ │
│ │- 计算组内平均特征    │ │  │ │- 计算组内平均特征    │ │  │ │- 计算组内平均特征    │ │
│ │- 计算组内平均logits  │ │  │ │- 计算组内平均logits  │ │  │ │- 计算组内平均logits  │ │
│ └─────────────────────┘ │  │ └─────────────────────┘ │  │ └─────────────────────┘ │
└──────────────────────────┘  └──────────────────────────┘  └──────────────────────────┘
            │                            │                            │
            │          统计信息传输       │                            │
            └────────────────────────────┼────────────────────────────┘
                                        ▼
                        ┌─────────────────────────────────────────────────┐
                        │                服务器端                          │
                        │            (FedNumServer)                      │
                        │                                               │
                        │ ┌─────────────────────────────────────────────┐ │
                        │ │统计信息聚合与整合                            │ │
                        │ │- 收集所有客户端的平均特征和logits              │ │
                        │ │- 按类别合并多客户端数据                      │ │
                        │ │- 构建全局统计信息字典                        │ │
                        │ └─────────────────────────────────────────────┘ │
                        │                       │                       │
                        │                       ▼                       │
                        │ ┌─────────────────────────────────────────────┐ │
                        │ │合成数据优化 (梯度匹配)                        │ │
                        │ │- 使用全局模型                                │ │
                        │ │- 计算合成数据的特征和logits                   │ │
                        │ │- 损失计算 (Wasserstein/KL/L2)              │ │
                        │ │- SGD优化器更新合成图像                       │ │
                        │ │- 迭代dc_iterations次                       │ │
                        │ └─────────────────────────────────────────────┘ │
                        │                       │                       │
                        │                       ▼                       │
                        │ ┌─────────────────────────────────────────────┐ │
                        │ │全局模型训练                                  │ │
                        │ │- 使用合成数据构建DataLoader                   │ │
                        │ │- SGD优化器训练全局模型                       │ │
                        │ │- 交叉熵损失函数                              │ │
                        │ │- 训练model_epochs轮次                      │ │
                        │ └─────────────────────────────────────────────┘ │
                        │                       │                       │
                        │                       ▼                       │
                        │ ┌─────────────────────────────────────────────┐ │
                        │ │模型评估与保存                                │ │
                        │ │- 在测试集上评估准确率                        │ │
                        │ │- 保存模型检查点                              │ │
                        │ │- 记录训练日志                                │ │
                        │ └─────────────────────────────────────────────┘ │
                        └─────────────────────────────────────────────────┘
```

## 2. FedNum算法详细工作流程

```
                                    ┌─────────────┐
                                    │  算法开始    │
                                    └─────────────┘
                                           │
                                           ▼
                          ┌─────────────────────────────────────┐
                          │        Phase 1: 初始化阶段          │
                          │                                     │
                          │  ┌─────────────────────────────┐    │
                          │  │1.1 创建全局模型              │    │
                          │  │    - 初始化神经网络          │    │
                          │  │    - 设置模型参数            │    │
                          │  └─────────────────────────────┘    │
                          │               │                     │
                          │               ▼                     │
                          │  ┌─────────────────────────────┐    │
                          │  │1.2 收集全局类别信息          │    │
                          │  │    - 遍历所有客户端          │    │
                          │  │    - 合并所有数据类别        │    │
                          │  │    - 构建self.all_classes   │    │
                          │  └─────────────────────────────┘    │
                          │               │                     │
                          │               ▼                     │
                          │  ┌─────────────────────────────┐    │
                          │  │1.3 初始化合成数据            │    │
                          │  │    - 随机初始化/真实样本初始化│    │
                          │  │    - 形状: [类别数×ipc, C, H, W] │    │
                          │  │    - 启用梯度计算            │    │
                          │  └─────────────────────────────┘    │
                          └─────────────────────────────────────┘
                                           │
                                           ▼
                          ┌─────────────────────────────────────┐
                          │    Phase 2: 联邦学习训练循环         │◄──────────┐
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.1: 模型性能评估            │           │
                          │                                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │- 检查是否为评估轮次          │    │           │
                          │  │  (round % eval_gap == 0)    │    │           │
                          │  │- 在测试集上评估模型准确率    │    │           │
                          │  │- 输出评估结果               │    │           │
                          │  └─────────────────────────────┘    │           │
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.2: 客户端选择和协调        │           │
                          │                                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │- 根据join_ratio随机选择客户端│    │           │
                          │  │- selected_clients = select_clients() │     │           │
                          │  │- 打印选中的客户端ID          │    │           │
                          │  └─────────────────────────────┘    │           │
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.3: 客户端数据处理          │           │
                          │                                     │           │
                          │  对每个选中的客户端执行:              │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │① client.receive_model()     │    │           │
                          │  │   - 深拷贝全局模型           │    │           │
                          │  │   - 设置为评估模式           │    │           │
                          │  └─────────────────────────────┘    │           │
                          │               │                     │           │
                          │               ▼                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │② client.train()            │    │           │
                          │  │   - 遍历客户端的每个类别     │    │           │
                          │  │   - 提取所有样本的特征和logits│    │           │
                          │  │   - 按avg_num分组平均化      │    │           │
                          │  │   - 返回统计信息字典         │    │           │
                          │  └─────────────────────────────┘    │           │
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.4: 服务器端合成数据更新    │           │
                          │                                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │① 统计信息聚合                │    │           │
                          │  │   - 合并所有客户端数据        │    │           │
                          │  │   - 按类别拼接张量           │    │           │
                          │  │   - all_avg_features/logits │    │           │
                          │  └─────────────────────────────┘    │           │
                          │               │                     │           │
                          │               ▼                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │② 梯度匹配优化循环            │    │           │
                          │  │   for dc_iteration in range(dc_iterations): │  │
                          │  │   - 创建全局模型                  │           │
                          │  │   - 计算合成数据的特征和logits│    │           │
                          │  │   - 计算匹配损失(特征+logits) │    │           │
                          │  │   - SGD更新合成图像          │    │           │
                          │  └─────────────────────────────┘    │           │
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.5: 全局模型训练            │           │
                          │                                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │① 构建合成数据集              │    │           │
                          │  │   - 获取合成图像和标签        │    │           │
                          │  │   - 创建TensorDataset        │    │           │
                          │  │   - 创建DataLoader           │    │           │
                          │  └─────────────────────────────┘    │           │
                          │               │                     │           │
                          │               ▼                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │② 模型训练循环                │    │           │
                          │  │   for epoch in range(model_epochs): │      │           │
                          │  │   - 前向传播计算预测         │    │           │
                          │  │   - 计算交叉熵损失           │    │           │
                          │  │   - 反向传播更新参数         │    │           │
                          │  └─────────────────────────────┘    │           │
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.6: 结果记录和模型保存      │           │
                          │                                     │           │
                          │  ┌─────────────────────────────┐    │           │
                          │  │- 计算平均训练损失            │    │           │
                          │  │- 记录到wandb日志             │    │           │
                          │  │- 保存模型检查点              │    │           │
                          │  │- 输出轮次统计信息            │    │           │
                          │  └─────────────────────────────┘    │           │
                          └─────────────────────────────────────┘           │
                                           │                               │
                                           ▼                               │
                          ┌─────────────────────────────────────┐           │
                          │   Step 2.7: 循环控制检查            │           │
                          │                                     │           │
                          │       rounds < communication_rounds ?          │
                          │                                     │           │
                          │         ┌─────┐    ┌─────────┐      │           │
                          │         │ 是  │    │   否     │      │           │
                          │         └─────┘    └─────────┘      │           │
                          └─────────────┬───────────────────────┘           │
                                       │              │                    │
                                       └──────────────┘                    │
                                                      │                    │
                                                      └────────────────────┘
                                                      │
                                                      ▼
                                            ┌─────────────┐
                                            │  算法结束    │
                                            │             │
                                            │ 返回最终的   │
                                            │ 全局模型     │
                                            └─────────────┘
```